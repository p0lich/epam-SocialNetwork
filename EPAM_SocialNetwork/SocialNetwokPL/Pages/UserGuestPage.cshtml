@using Dependencies;
@using EPAM.SocialNetwork.BLL.Interfaces
@using Entities;

@{if (!User.IsInRole("user"))
    {
        Response.Redirect("~/Pages/Login.cshtml");
    }
}

@{
    Layout = "~/Pages/Layouts/_BasicLayout.cshtml";

    ILogic logic = DependencyResolver.GetInstance().UserLogic;

    User currentUser = logic.GetUser(User.Identity.Name);
    User viewedUser;

    if (Request.QueryString.Count != 0)
    {
        viewedUser = logic.GetUser(Request.QueryString.Get("viewedUser"));
    }

    else
    {
        viewedUser = currentUser;
    }

    string viewedUserLogin = Request.QueryString.Get("viewedLogin");

    string fn = currentUser.FirstName == null ? "(no info)" : viewedUser.FirstName;
    string ln = currentUser.LastName == null ? "(no info)" : viewedUser.LastName;
    string bd = currentUser.DateOfBirth == null ? "(no info)" : viewedUser.DateOfBirth.ToString();

    string userImage;

    if (string.IsNullOrEmpty(currentUser.Image))
    {
        userImage = @"../UsersImages/DefaultUserIcon.png";
    }

    else
    {
        userImage = @"../UsersImages/" + currentUser.Image;
    }

    if (IsPost)
    {
        if (Request.Form.AllKeys.Contains("addFriendButton"))
        {
            logic.AddFriend(currentUser.Id, viewedUser.Id);
        }

        if (Request.Form.AllKeys.Contains("removeFriendButton"))
        {
            logic.RemoveFriend(currentUser.Id, viewedUser.Id);
        }

        if (Request.Form.AllKeys.Contains("deleteAccaunt"))
        {
            logic.DeleteUser(currentUser.Id);
            FormsAuthentication.SignOut();
            Response.Redirect("~/Pages/Login.cshtml");
        }
    }
}

<div class="UserInfo_Container">
    <div class="Left_Data Data_Border">
        <div class="Text_Container Border_Line__Bottom">
            <p class="Label_Login">@currentUser.Login</p>
        </div>
        <div class="Image_Container Border_Line__Bottom">
            <img src="@userImage" class="Profile_Image">
        </div>
        @{
            if (currentUser.Login != viewedUser.Login)
            {
                if (logic.IsFriend(currentUser.Login, Request.QueryString.Get("viewedUser")))
                {
                    <form method="post">
                        <input type="submit" value="Remove from friends" name="removeFriendButton">
                    </form>
                }

                else
                {
                    <form method="post">
                        <input type="submit" value="Add to friend" name="addFriendButton">
                    </form>
                }
            }

            else
            {
                <form method="post">
                    <input type="submit" value="Delete accaunt" name="deleteAccauntButton">
                </form>

                <form method="get">
                    <input type="submit" value="Edit profile info" name="editButton">
                </form>
            }
        }
    </div>

    <div class="Right_Data Data_Border">
        <!-- data that will be shown
        First name
        Last name
        Date of birth
        Age(?)
        Friend count(?)
        -->

        <div class="Table_Lable">
            <p class="Border_Line__Bottom">First name</p>
            <p class="Border_Line__Bottom">Last name</p>
            <p>Date of birth</p>
            @*<p></p>
                <p></p>*@
        </div>

        <div class="Table_Data">
            <p class="Border_Line__Bottom">@fn</p>
            <p class="Border_Line__Bottom">@ln</p>
            <p>@bd</p>
            @*<p></p>
                <p></p>*@
        </div>
    </div>
</div>

<!--Template-->
@*@{if (!User.IsInRole("user"))
        {
            Response.Redirect("~/Pages/Login.cshtml");
        }
    }

    @{
        Layout = "~/Pages/Layouts/_BasicLayout.cshtml";
    }*@